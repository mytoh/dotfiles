
# options {{{
set -o utf8-mode
set -o ignoreeof
set -o physical
set -o trackall
#}}}

# variables
blue="[38;5;004m"
normal_color="[38;5;8m"
green="[38;5;6m"
reset_color="[0m"

# prompt

reload-rc() {
source ~/.mkshrc
}

current-directory() {
  local d=${PWD:-?} p=~; [[ $p = ?(*/) ]] || \
    d=${d/#$p/~}; local m=${%d} n p=...; (( m > 0 )) || m=${#d}
  (( m > (n = (COLUMNS/3 < 7 ? 7 : COLUMNS/3)) )) && d=${d:(-n)} || \
    p=; print -nr -- "$p$d"
}

parse-git-branch() { #{{{
  if [[ -e $PWD/.git ]]; then
    gitver=$(git branch 2>/dev/null | sed -n '/^\*/s/^\* //p')
    echo -ne "${normal_color}â”€($(branch-color)${gitver}${normal_color})"
  else
    return 0
  fi
  }

  branch-color() {
    local color=""
    if git diff --quiet 2>/dev/null >&2
    then
      color="[38;5;2m"
    else
      color="[38;5;1m"
    fi
    echo -ne $color
  }
  #}}}

set-prompt() {
printf "%s%s%s\n%s"       \
  "${normal_color}â”Œâ”€$reset_color" "${normal_color}(${blue}$(current-directory)${normal_color})" "$(parse-git-branch)" \
  "${normal_color}â””â”ˆâ•¸${reset_color} "


}
PS1='$(set-prompt)''$(reload-rc)'

# environmet variables {{{

# path {{{
set-path() {
unset PATH
local p
for p in \
  /sbin                \
  /bin                 \
  /usr/local/sbin      \
  /usr/local/bin       \
  /usr/sbin            \
  /usr/bin             \
  /usr/X11/bin         \
  /usr/games           \
  /opt/X11/bin         \
  ~/local/homebrew/bin \
  ~/local/homebrew/sbin \
  ~/local/bin      ;
do
  [[ -d $p/. ]] || continue
  [[ :$PATH: = *:$p:* ]] || PATH=$p:$PATH
done
export PATH
}
set-path

set-manpath() {
local m
MANPATH="$(manpath)"
for m in     \
  /usr/share/man/              \
  /usr/local/share/man         \
  ~/local/homebrew/share/man \
  ~/local/share/man \
  ~/local/man ;    
  do
    [[ -d $m/. ]] || continue
    [[ :$MANPATH: = *:$m:* ]] || MANPATH=$m:$MANPATH
  done
  export MANPATH
}
if [[ "$(uname -s)" != FreeBSD ]]; then
  set-manpath
fi

# must contain "." for current directory
export CDPATH=.:~/local:~/local/var
#}}}

MKSH=$(whence -p mksh)
if whence -p vim >&-; then
  : ${EDITOR:=vim}
else
  : ${EDITOR:=vi}
fi
: ${TERM:=xterm} ${LANG:=en_GB.UTF-8}
[[ $HOSTNAME = @(localhost|*([	 ])) ]] && HOSTNAME=$(ulimit -c 0;hostname 2>&-)
export HOSTNAME EDITOR TERM LANG
export SHELL=$MKSH MANWIDTH=80 LESSHISTFILE=-
export HISTFILE=~/.mksh_history
export HISTSIZE=999999
export GAUCHE_LOAD_PATH=~/.gosh
export DYLD_FALLBACK_LIBRARY_PATH=$HOME/local/lib:$HOME/local/homebrew/lib
if [[ -d $HOME/local/stow ]]; then
  export STOW=$HOME/local/stow
fi

# pager
export LESS='-i  -w -z-4 -g -M -X -F -R -P%t?f%f \
  :stdin .?pb%pb\%:?lbLine %lb:?bbByte %bb:-...'
export LESS_TERMCAP_mb=$'\E[01;31m'
export LESS_TERMCAP_md=$'\E[01;31m'
export LESS_TERMCAP_me=$'\E[0m'
export LESS_TERMCAP_se=$'\E[0m'
export LESS_TERMCAP_so=$'\E[01;44;33m'
export LESS_TERMCAP_ue=$'\E[0m'
export LESS_TERMCAP_us=$'\E[01;32m'


# set default browser
if whence -p w3m >&-; then
  export BROWSER=w3m
fi

# named directories {{{
# $ cd ~dir
alias -d quatre=~/local/mnt/quatre
alias -d desk=~/local/mnt/deskstar
alias -d mypass=~/local/mnt/mypassport
alias -d git=~/local/git
alias -d ports=/usr/ports
alias -d tmp=~/local/tmp
# }}}
#}}}

# functions {{{

# give MidnightBSD's laffer1 a bit of csh feeling
setenv() {
  eval export $1'="$2"'
}

if whence -p gosh >&- && [[ -e $GAUCHE_LOAD_PATH/ls.scm ]]; then
  cd() {
    builtin cd "$@" && \
      command gosh ls.scm -d .
  }
else
  cd() {
    buitin cd "$@"
  }
fi

tm() {
  tmux -u attach
}

color-numbers() {
for i in $(seq 000 16 255)
do
  for j in $(seq ${i} $((i + 15)))
  do
    echo -en "[38;5;${j}m $j [0m"
  done
  echo
done
}

xsource() { # {{{
  # from grml zshrc
  # Check if we can read given files and source those we can.
  if (( $# < 1 )) ; then
    printf 'usage: xsource FILE(s)...\n' >&2
    return 1
  fi

  while (( $# > 0 )) ; do
    [[ -r "$1" ]] && source "$1" > /dev/null 2>&1 ;
    shift
  done
  return 0
}

ggr()  {
  # Search Google
  ${BROWSER} "http://www.google.com/search?&num=100&q=$*"
}

recent-file() {
command ls -c -t -1 |head -n "$1"|tail -n 1
}

scm() {
  case $1 in
    g|gauche|gosh)
      print "gauche"
      rlwrap -pBlue -b '(){}[].,#@;| ' -c gosh 
      ;;
    sc|scsh)
      print "scsh"
      rlwrap -pBlue -b '(){}[],#;| ' -c scsh   
      ;;
    s4|scheme48)
      print "scheme48"
      rlwrap -pBlue -b '(){}[],#;| ' -c scheme48
      ;;
    e|elk)
      print "elk"
      rlwrap -pBlue -b '(){}[],#;| ' -c elk 
      ;;
    *)
      print "  g  gauche"
      print "  sc scsh"
      print "  s4 scheme48"
      print "  e elk"
      ;;
  esac
}

vim() {
  if [ -n $DISPLAY ]; then
    command vim $*
  else
    command vim -X $*
  fi
}

trls() { 
  aria2c -S "$@" | grep "./"
}

4ch() {
  w3m http://boards.4chan.org/$1/
}

exif-remove() {
  mogrify -strip -verbose $*
}
#}}}

# aliases {{{
if whence -p gosh >&- ; then
  alias yotsuba='command gosh yotsuba-get.scm'
  alias futaba='command gosh futaba-get.scm'
  alias spc2ubar='command gosh space2underbar.scm'
  alias ea='command gosh extattr.scm'
  alias unpack='command gosh unpack.scm'
  if [[ -e $GAUCHE_LOAD_PATH/ls.scm ]]; then
    alias ls='command gosh ls.scm -d'
    alias la='command gosh ls.scm -d -a'
    alias ll='command gosh ls.scm -d -psf'
    alias lla='command gosh ls.scm -d -psf -a'
    alias l='command gosh ls.scm -d'
  fi
fi

if whence -p cdf >&- ; then
  alias df='cdf -h'
else
  alias df='df -h'
fi
alias single="sudo shutdown now"
alias halt="sync;sync;sync;sudo shutdown -p now"
alias reboot="sync;sync;sync;sudo shutdown -r now"
alias sudo="sudo -E "
alias xfont="xlsatoms | grep '-'"
alias which='whence -p'
alias rr='command rm -rfv'
alias mkd='command mkdir -p'
alias stow='stow --verbose=3'
# net {{{
alias starwars='telnet towel.blinkenlights.nl'
alias radio1='mplayer -playlist http://www.bbc.co.uk/radio/listen/live/r1.asx'
alias radio2='mplayer -playlist http://www.bbc.co.uk/radio/listen/live/r2.asx'
alias radio3='mplayer -playlist http://www.bbc.co.uk/radio/listen/live/r3.asx'
alias radio4='mplayer -playlist http://www.bbc.co.uk/radio/listen/live/r4.asx'
alias radio6='mplayer -playlist http://www.bbc.co.uk/radio/listen/live/r6.asx'
alias sumo='mplayer -playlist http://sumo.goo.ne.jp/hon_basho/torikumi/eizo_haishin/asx/sumolive.asx'
alias jblive='mplayer rtsp://videocdn-us.geocdn.scaleengine.net/jblive/jblive.stream'
alias sumo='mplayer -playlist http://sumo.goo.ne.jp/hon_basho/torikumi/eizo_haishin/asx/sumolive.asx'
alias sumo2='mplayer mms://a776.l12513450775.c125134.a.lm.akamaistream.net/D/776/125134/v0001/reflector:50775'
alias sumo3='mplayer mms://a792.l12513450791.c125134.a.lm.akamaistream.net/D/792/125134/v0001/reflector:50791'
alias destep="figlet -w 80 -nkf rowancap DESTEP TRED | tr 'd' 'â–Ÿ' | tr 'P' 'â–›' | tr 'M' 'â–ˆ' | tr 'V' 'â–œ' | tr '\"' ' ' | tr '.' ' ' | tr 'a' 'â–Ÿ' | tr 'b' 'â–™' | tr 'K' 'â–ˆ' | tr 'A' 'â–Ÿ' | tr 'F' 'â–›' | tr 'Y' 'â–œ' | tr 'v' 'â–ˆ' | tr 'm' 'â–ˆ' | tr 'r' 'â–›' | toilet -w 80 --gay -f term"
#}}}
#}}}

# key bindings
bind ''=search-history-up

# misc {{{
 # f.sh {{{
if [[ -e $HOME/local/git/f/f.sh ]]; then
  # MAX total score/weight, default is 2000
  _F_MAX=10000
  xsource $HOME/local/git/f/f.sh 
  # ignore commands , default "_f cd ls echo"
  _F_IGNORE+=" make gnumake gmake ./configure"
  alias z='f -d -e cd'
  alias v='f -e vim'
  alias m='f -e mplayer'
  alias o='f -e xdg-open'
fi
 # }}}

if [[ -n $DISPLAY ]];then
  if [[ -e ~/.fonts ]]; then
    for d in ~/.fonts/*(/); do
      if [[ -e $d/fonts.dir ]]; then
      xset +fp $d
    fi
      xset fp rehash
    done
  fi
fi
#}}}

# os {{{
case $(uname) in
  FreeBSD)
    # PACKAGESITE="ftp://ftp.jp.FreeBSD.org/pub/FreeBSD/ports/i386/packages/Latest/"
    alias pup="sudo portsnap fetch update "
    alias pcheck='sudo portmaster -PBidav && sudo portaudit -Fdav && sudo portmaster -y --clean-packages --clean-distfiles --check-depends'
    alias pfetch="sudo make  fetch-recursive"
    alias pinst="sudo make  install distclean; rehash"
    alias pconf="sudo make config-recursive"
    alias pclean="sudo make  clean "
    alias pkg_add="pkg_add -v"
    alias pcreate="pkg_create -RJvnb"
    alias pcreateall="pkg_info -Ea |xargs -n 1 sudo pkg_create -Jnvb"

if [[ $TERM = cons25 && -e `which jfbterm` ]]; then
  jfbterm
fi

  beastie() {
    echo '
    
    
                \e[31m,        ,                              
               /(        )`                                   
               \ \___   / |                                   
               /- \e[37m_\e[31m  `-/  '\''                      
              (\e[37m/\/ \\\e[31m \   /\                       
              \e[37m/ /   |\e[31m `    \                      
              \e[34mO O   \e[37m) \e[31m/    |                
              \e[37m`-^--'\''\e[31m`<     '\''                      
             (_.)  _  )   /                                   
              `.___/`    /                                   
                `-----'\'' /                                     
   \e[33m<----.\e[31m     __ / __   \                         
   \e[33m<----|====\e[31mO)))\e[33m==\e[31m) \) /\e[33m====]  
   \e[33m<----'\''\e[31m    `--'\'' `.__,'\'' \                        
               |        |                                    
                \       /       /\                           
           \e[36m______\e[31m( (_  / \______/                
         \e[36m,'\''  ,-----'\''   |                               
         `--{__________)\e[37m                                 '



}

orb() {
  echo '
     \e[31m```                        \e[31;1m`\e[31m    
\e[31;1m    s` `.....---...\e[31;1m....--.```   -/\e[31m         
    +o   .--`         \e[31;1m/y:`      +.\e[31m         
     yo`:.            \e[31;1m:o      `+-\e[31m          
      y/               \e[31;1m-/`   -o/\e[31m           
     .-                  \e[31;1m::/sy+:.\e[31m          
\e[37m     /                     \e[31;1m`--  /\e[31m          
\e[37m    `\e[31m:                          \e[31;1m:`\e[31m         
\e[37m    `\e[31m:                          \e[31;1m:`\e[31m         
\e[37m     /                          \e[31;1m/\e[31m          
\e[37m     .\e[31m-                        \e[31;1m-.\e[31m          
      --                      \e[31;1m-.\e[31m           
       `:`                  \e[01;31m`:`                  
         \e[31;1m.--             \e[37m`-\e[33m-.                    
            .---...\e[33m...----                         '
}


;;

  Darwin)
    alias mp2="/Applications/mplayer2.app/Contents/MacOS/mplayer-bin"
    alias bsearch="brew search "
    alias binst="brew install -v"
    squid_restart() {
      killall squid
      killall squid
      kill $(cat ~/.squid/logs/squid.pid)
      kill $(cat ~/.squid/logs/squid.pid)
      /bin/rm -rfv ~/.squid/cache/*
      squid -f ~/.squid/etc/squid.conf -z
      squid -f ~/.squid/etc/squid.conf
    }
    export HOMEBREW_VERBOSE
    export JAVA_HOME=~/Library/JAVA/JavaVirtualMachines/1.7.0.jdk/Contents/Home
     xsource `brew --prefix`/etc/autojump
     xsource `brew --prefix`/etc/bash_completion.d/git-completion.bash
    ;;

esac
#}}}




unset p

# vim:foldmethod=marker
